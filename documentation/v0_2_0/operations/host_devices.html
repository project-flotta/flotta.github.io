<!DOCTYPE html>
<html lang="en">

<head>
  <script id="dpal" src="//www.redhat.com/ma/dpal.js" type="text/javascript"></script>
  <meta charset="utf-8">
  <title>Project Flotta</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="this is meta description">

  

  <!-- ** Plugins Needed for the Project ** -->
  
  <link rel="stylesheet" href="/assets/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/assets/plugins/themify-icons/themify-icons.css">
  
  <link rel="stylesheet" href="/assets/plugins/slick/slick.css">
  

  <link href="/assets/scss/syntax_monokai.css" rel="stylesheet">
  <!-- Main Stylesheet -->
  <link href="/assets/scss/style.css" rel="stylesheet">

  <!--Favicon-->
  <link rel="shortcut icon" href="/assets/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="/assets/images/flotta-logo-stacked.ico " type="image/x-icon">

  <!-- google analytics -->
  

</head>


<body>

  <header class="navigation fixed-top nav-bg">
  <nav class="navbar navbar-expand-lg navbar-dark">
    <a class="navbar-brand font-tertiary h3" href="/">
      
        <img src="/assets/images/flotta-logo.png" alt="Project Flotta" style="height: 60px;">
        
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation"
      aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse text-center" id="navigation">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item active">
          <a class="nav-link" href="/">Home</a>
        </li>
        
          <li class="nav-item ">
            <a class="nav-link" href="/blog.html">Blog</a>
          </li>
        
          <li class="nav-item ">
            <a class="nav-link" href="/documentation/v0_2_0/intro/overview.html">Documentation</a>
          </li>
        
      </ul>
    </div>
  </nav>
</header>


  <section class="section skip_top">
  <div class="container">
    <div class="row">
      <div class="col-lg-4">
        
        
        <ul class="list-group list-group-collapse border-0">
          
          <li class="list-group-item border-0">
            <h5>
              
              Intro
              
            </h5>
            
            <ul class="list-group border-0">
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/intro/overview.html">What is flotta</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/intro/usecases.html">Use cases</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/intro/vs.html">Flotta vs others</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/intro/concepts.html">Concepts</a> </li>
              
            </ul>
            
          </li>
          
          <li class="list-group-item border-0">
            <h5>
              
              Getting started
              
            </h5>
            
            <ul class="list-group border-0">
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/gsg/minikube.html">Minikube</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/gsg/kind.html">Kind</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/gsg/ocp.html">OCP</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/gsg/running_workloads.html">Running workloads</a> </li>
              
            </ul>
            
          </li>
          
          <li class="list-group-item border-0">
            <h5>
              
              Operations
              
            </h5>
            
            <ul class="list-group border-0">
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/requirements.html">System Requirements</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/deployment_options.html">Deployment options</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/configuration.html">Configuration</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/remote_data_store.html">Remote Edge Configuration API</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/observability.html">Observability</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/data_synchronization.html">Data Synchronization</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/troubleshooting.html">Troubleshooting</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/api.html">API reference</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/crd.html">CRD reference</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/host_devices.html">Accessing host devices</a> </li>
              
            </ul>
            
          </li>
          
          <li class="list-group-item border-0">
            <h5>
              
              For developers
              
            </h5>
            
            <ul class="list-group border-0">
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/dev/installation.html">Manual installation & tips</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/dev/guide.html">Development Guide</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/dev/profiling.html">Profiling</a> </li>
              
            </ul>
            
          </li>
          
        </ul>
        <p>Documentation for version: <b>v0.2.0</b></p>
        <ul class="list-group list-group-collapse border-0">
          <li class="list-group-item border-0">
            <h5>Other versions</h5>

            <ul class="list-group border-0">
              
              
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/intro/overview.html"> v0.1.0</a> </li>
              
              
              
              
              <li class="list-group-item border-0"> <a href="/documentation/latest/intro/overview.html"> latest</a> </li>
              
              
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/intro/overview.html"> v0.2.0</a> </li>
              
            </ul>
          </li>

        </ul>
      </div>

      <div class="col-lg-8">
        <div class="documentation content">
          
          

          <h1 id="accessing-host-devices-from-a-workload">Accessing host devices from a workload</h1>

<p>To reduce the security thread that can generate from running workloads at the edge, flotta is configured by default to run the workloads in rootless containers. While this increases the device’s security and prevents pods from escaping containers and having full access to the device, it also impacts a few use cases where there is a need to access mounted host devices such as webcams, sensors or other plugged devices, since the containers are no longer able to access the mounted devices.</p>

<p>Even in a rootless container and with SELinux enabled, it is possible for workloads to have access to a mounted device, provided that the host and the workload are configured properly.</p>

<h2 id="adding-the-supplementary-group-to-the-flotta-user">Adding the supplementary group to the <code class="language-plaintext highlighter-rouge">flotta</code> user</h2>

<p>To run the workloads in a rootless mode, the flotta agent creates the <code class="language-plaintext highlighter-rouge">flotta</code> user when installed. At the same time, the device agent leverages on this account to start the workloads in rootless mode. For a workload to mount a host mountpoint to the container, it first needs the <code class="language-plaintext highlighter-rouge">flotta</code> host user to have access to the device.</p>

<p>This can be achieved by adding the device’s group as a supplementary group to the <code class="language-plaintext highlighter-rouge">flotta</code> user. In case of a webcam, the group is <code class="language-plaintext highlighter-rouge">video</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@fedora ~]# <span class="nb">ls</span> <span class="nt">-la</span> /dev/video2
crw-rw----. 1 root video 81, 2 Jul 22 16:14 /dev/video2
</code></pre></div></div>

<p>And adding the supplementary group is a simple command:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@fedora ~]# usermod <span class="nt">-a</span> <span class="nt">-G</span> video flotta
</code></pre></div></div>
<p>Since we have changed the flotta group list, we will restart the systemd user service that hosts the podman instance running with the <code class="language-plaintext highlighter-rouge">flotta</code> user. This change is required to propagate the changes to the running proceses under the <code class="language-plaintext highlighter-rouge">flotta</code> account:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@device ~]# systemctl restart user@<span class="si">$(</span><span class="nb">id </span>flotta <span class="nt">-g</span><span class="si">)</span>.service
</code></pre></div></div>

<p>Adding the supplementary group will allow the <code class="language-plaintext highlighter-rouge">flotta</code> user to access the device from a file system perspective, but we need to enable the access to the containers. For that purpose we have to make additional adjustments to the workload.</p>

<h2 id="keep-the-groups-in-the-container">Keep the groups in the container</h2>

<p>Adding the supplementary group <code class="language-plaintext highlighter-rouge">video</code> to the <code class="language-plaintext highlighter-rouge">flotta</code> user will clear the access to the device from a filesystem perspective. But since the workloads run in a container, we also need to look at how to instruct the container runtime to use the same groups from the <code class="language-plaintext highlighter-rouge">flotta</code> user in the container’s user so that the host file system allows access from the user running inside the container. For security reasons, the user id and group id running inside the container is different than the one in the host.</p>

<p>Propagating the groupIds enables container processes access to host files without being blocked by the host’s file system due to invalid access rights. To do so, Flotta leverages on a feature from the <code class="language-plaintext highlighter-rouge">crun</code> runtime container that, when used, instructs the runtime to keep the same group Ids from the user’s host to the container. In Flotta this feature is eanbled by defining in your workload the following annotation <code class="language-plaintext highlighter-rouge">podman/run.oci.keep_original_groups: "1"</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: management.project-flotta.io/v1alpha1
kind: EdgeWorkload
metadata:
  name: webcam
  annotations:
    podman/run.oci.keep_original_groups: "1"
spec:
...
...

</code></pre></div></div>

<h2 id="facing-selinux">Facing SELinux</h2>
<p>With SELinux enabled by default, rootless containers have further restrictions to access the host file system. For mounted devices this is no different. There are two approaches on how to allow a workload to access a mounted device with SELinux’s blessings:</p>

<ul>
  <li>Define the SELinux rules specific for the mounted device</li>
  <li>Use the <code class="language-plaintext highlighter-rouge">seLinuxOptions</code> in the pod’s <code class="language-plaintext highlighter-rouge">spec</code> field to instruct the runtime to define the type as <code class="language-plaintext highlighter-rouge">spc_t</code> to what is in essence disabling SELinux in the container. Since we are running a rootless container, the security impact is limited to what the <code class="language-plaintext highlighter-rouge">flotta</code> user is able to do. <a href="https://danwalsh.livejournal.com/74754.html">Here</a> is a detailed explanation of what it is and can do for those initiated in the art of container runtime.</li>
</ul>

<p>Let’s see them in more detail:</p>

<h3 id="defining-the-selinux-rules-specific-for-the-device">Defining the SELinux rules specific for the device</h3>
<p>The process is to run the workload and identify the missing SELinux rules that prevent the workload from operating the device and finally configure SELinux to add the new rules. The process relies on the <code class="language-plaintext highlighter-rouge">audit2allow</code> utility to capture the denial attempts in <code class="language-plaintext highlighter-rouge">/var/log/audit/audit.log</code> and generate the rules to allow the access.</p>

<p>The following rules are an example of the outcome of running the <code class="language-plaintext highlighter-rouge">audit2allow</code> utility after various attempts to run a workload that interacts with a webcam:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module v4linux 1.0<span class="p">;</span>

require <span class="o">{</span>
	<span class="nb">type </span>v4l_device_t<span class="p">;</span>
	<span class="nb">type </span>container_t<span class="p">;</span>
	class chr_file <span class="o">{</span> getattr ioctl map open <span class="nb">read </span>write <span class="o">}</span><span class="p">;</span>
<span class="o">}</span>

<span class="c">#============= container_t ==============</span>

<span class="c">#!!!! This avc can be allowed using the boolean 'container_use_devices'</span>
allow container_t v4l_device_t:chr_file <span class="o">{</span> getattr ioctl open <span class="nb">read </span>write <span class="o">}</span><span class="p">;</span>
allow container_t v4l_device_t:chr_file map<span class="p">;</span>
</code></pre></div></div>

<p>In some cases, setting the <code class="language-plaintext highlighter-rouge">container_use_devices</code> boolean to true in SELinux (<code class="language-plaintext highlighter-rouge">setsebool container_use_devices on</code>) might be sufficient to allow containers from interacting with the devices. As you can see in the example above, additionally to the operations allowed by the boolean of <code class="language-plaintext highlighter-rouge">getattr</code>, <code class="language-plaintext highlighter-rouge">ioctl</code>, <code class="language-plaintext highlighter-rouge">open</code>, <code class="language-plaintext highlighter-rouge">read</code> and <code class="language-plaintext highlighter-rouge">write</code>, the <code class="language-plaintext highlighter-rouge">map</code> action is also required in the case of the webcam.</p>

<p>The downside of this approach is that requires additional configuration changes to the device and also to run the workload a few times until the correct rules have been generated, but when achieved it can be used to configure all hosts with the same device as part of the onboarding and configuration process even before installing Flotta. From a security perspective it can be an appealing option.</p>

<h3 id="the-super-privileged-container">The Super Privileged Container</h3>
<p>For those who want a more straight forward approach and don’t want to mess with SELinux rules for each device, there is a special SELinux label type named <code class="language-plaintext highlighter-rouge">Super Privilege Container</code> or <code class="language-plaintext highlighter-rouge">spc_t</code> that in essence it disables SELinux in the container. Here is an example of a workload that accesses a webcam and uses this type to overcome the different SELinux types between the process running in the container and the device.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">management.project-flotta.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">EdgeWorkload</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">webcam</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">podman/run.oci.keep_original_groups</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">deviceSelector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">webcam</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">pod</span>
  <span class="na">pod</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">quay.io/jordigilh/ffmpeg:latest</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">fedora</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/dev/video2</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">video</span>
        <span class="na">securityContext</span><span class="pi">:</span>
          <span class="na">seLinuxOptions</span><span class="pi">:</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s1">'</span><span class="s">spc_t'</span>
      <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Always</span>      
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">video</span> 
        <span class="na">hostPath</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/dev/video2</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">File</span>
</code></pre></div></div>


        </div>
      </div>
    </div>
  </div>
</section>

  <!-- footer -->
<footer class="bg-dark footer-section">
  <div class="section">
    <div class="container">
      <div class="row">
        <div class="col-md-4">
          <h5 class="text-light">Email</h5>
          <p class="text-white paragraph-lg font-secondary">flotta@redhat.com</p>
        </div>
        <div class="col-md-4">
          <h5><a href="http://www.redhat.com"><img id="sponsorship" class="footerLogo" src="/assets/images/Logo-Red_Hat-Supported_By-A-Reverse-RGB.svg"></a>.</h5>
        </div>
        <!-- <div class="col-md-4"> -->
        <!--   <h5 class="text-light">Address</h5> -->
        <!--   <p class="text-white paragraph-lg font-secondary"></p> -->
        <!-- </div> -->
      </div>
    </div>
  </div>
  <div class="border-top text-center border-dark py-5">
    <p class="mb-0 text-light"><p>Copyright © 2020 Designed by <a href="https://themefisher.com">Themefisher</a> &amp; Developed by <a href="https://getjekyllthemes.com">Getjekyllthemes</a></p>
</p>
  </div>
</footer>
<!-- /footer -->


<!-- JS Plugins -->

<script src="/assets/plugins/jQuery/jquery.min.js"></script>

<script src="/assets/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/assets/plugins/shuffle/shuffle.min.js"></script>

<script src="/assets/plugins/slick/slick.min.js"></script>


<!-- Main Script -->
<script src="/assets/js/script.js"></script>

<!-- This comes from DTM/DPAL and must be latest entry in body-->
<script type="text/javascript">
  if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
      _satellite.pageBottom();
  }
</script>


<script>
  $(function() {
    return $("h2, h3, h4, h5, h6").each(function(i, el) {
      var $el, icon, id;
      $el = $(el);
      id = $el.attr('id');
      icon = '<i class="ti-link"></i>';
      console.log("test test"+id)
      if (id) {
        return $el.prepend($("<a />").addClass("header-link").attr("href", "#" + id).html(icon));
      }
    });
  });
</script>


</body>

</html>
